{% extends 'admin/admin.html' %}
{% load custom %}
{% load compress %}

{% block admin-content %}
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    box-header
                </div>
                <div class="box-body">
                    {% include 'admin/table_category.html' %}
                </div>
            </div>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-sm">
                New Category
            </button>

            <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="padding: 10px;width: 600px">
                        <div class="box-body">
                            <p class="box-header">New Category</p>
                            <div class="col-sm-10">
                                <p><input type="text" class="form-control" name="name" placeholder="英文版块名称"
                                          id="cg_name">
                                </p>
                                <p><input type="text" class="form-control" name="brief" placeholder="中文版块名称"
                                          id="cg_alias">
                                </p>
                            </div>
                        </div>
                        <div class="box-footer">
                            <button class="btn btn-success pull-right " data-dismiss="modal" onclick="Create()">Create</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <nav>
                    <ul class="pagination">
                        {% if posts.has_previous %}
                            <li class="">
                                <a href="?page={{ posts.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        {% for page_num in posts.paginator.page_range %}
                            {% guess_page posts.number page_num %}
                        {% endfor %}
                        {% if shcool_list.has_next %}
                            <li class="">
                                <a href="?page={{ posts.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>

    </div>
{% endblock %}

{% block admin-js %}
    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        console.log(csrftoken);

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                var csrftoken = getCookie('csrftoken');
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        var editHTML;
        var editText;
        function setEditHTML(value) {
            editHTML = '<input type="text" value="' + value + '" />';
            editHTML += '<input type="button" onclick="ok(this)" value="Edit" />';
            editHTML += '<input type="button" onclick="del(this)" value="Del" />';
            editHTML += '<input type="button" onclick="cancel(this)" value="Cancel" />';
        }
        //绑定事件
        $(".editbox").each(function () { //取得所有class为editbox的对像
            $(this).bind("dblclick", function () { //给其绑定双击事件
                editText = $(this).html(); //取得表格单元格的文本
                setEditHTML(editText); //初始化控件
                $(this).data("oldtxt", editText) //将单元格原文本保存在其缓存中，便修改失败或取消时用
                        .html(editHTML) //改变单元格内容为编辑状态
                        .unbind("dblclick"); //删除单元格双击事件，避免多次双击
            });
        });
        //取消
        function cancel(cbtn) {
            var $obj = $(cbtn).parent(); //'取消'按钮的上一级，即单元格td
            $obj.html($obj.data("oldtxt")); //将单元格内容设为原始数据，取消修改
            $obj.bind("dblclick", function () { //重新绑定单元格双击事件
                editText = $(this).html();
                setEditHTML(editText);
                $(this).data("oldtxt", editText)
                        .html(editHTML).unbind("dblclick");
            });
        }
        function Add(ths) {
            $("#btn_addtr").click(function () {
                $('tbody').append('<tr id=""><td></td><td class="editbox"></td><td></td></tr>')
            });

        }
        //删除
        function del(ths) {
            var $obj = $(ths).parent(); //'修改'按钮的上一级，即单元格td
            var cid = $obj.parent().attr("id").replace("tr_", ""); //取得该行数据的ID，此例ID绑定在tr中
            //console.log(cid);
            $('#tb1').html("");
            $.ajax({
                type: 'POST',
                url: "/blog/category/" + cid + "/del/",
                data: {pk: cid},
                success: function (data) {
                    //      console.log(data);
                    $("#tb1").html(data);
                }
            });
        }

        //修改
        function ok(obtn) {
            var $obj = $(obtn).parent(); //'修改'按钮的上一级，即单元格td
            var cid = $obj.parent().attr("id").replace("tr_", ""); //取得该行数据的ID，此例ID绑定在tr中
            var value = $obj.find("input:text")[0].value; //取得文本框的值，即新数据
            //AJAX 修改数据
            $.ajax({
                type: "POST",
                url: "/category_old/",
                data: {name: value, id: cid},//data:版块名称/版块ID
                success: function (msg) {
                    //alert("Data Saved: " + msg);
                }
            });
            console.log(value, cid);
//成功
            if (true) {
                //alert("success");
                $obj.data("oldtxt", value); //设置此单元格缓存为新数据
                cancel(obtn); //调用'取消'方法，
//在此应传'取消'按钮过去，
//但在'取消'事件中没有用'取消'按钮这个对 象,
//用的只是它的上一级，即td，
//固在此直接用'修改'按钮替代
            }
//失败
            else {
                alert("error");
                cancel(obtn);
            }

        }

        function Create(obj) {
            var val_name = $('#cg_name').val();
            var val_alias = $('#cg_alias').val();
            $.ajax({
                url: "/edit/",
                type: 'POST',
                data: {type: 'cg', name: val_name, alias: val_alias},
                success: function (data) {
                    console.log(data);
                    window.location.reload();
                }

            });
        }

    </script>
{% endblock %}